<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SkyBank — Autoscaling Demo</title>
  <style>
    :root{
      --bg:#0f1220; --panel:#171a2b; --muted:#8892b0; --fg:#e6e6f0; --brand:#7c5cff; --brand-2:#9b72ff; --ok:#22c55e; --warn:#f59e0b;
      --chip:#1f2237; --chip-active:#2a2f4d; --border:#2a2e45; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 700px at 15% -10%, #2a2f4d 0%, transparent 60%), var(--bg); color:var(--fg); font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    header{padding:32px 24px 10px; max-width:1100px; margin:0 auto}
    .title{font-size:28px; font-weight:800; letter-spacing:.3px; background:linear-gradient(90deg,var(--brand),var(--brand-2)); -webkit-background-clip:text; background-clip:text; color:transparent}
    .sub{color:var(--muted); margin-top:6px}
    main{max-width:1100px; margin:18px auto 56px; padding:0 24px}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); overflow:hidden}
    .card-hd{display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--border)}
    .card-ttl{font-weight:700; font-size:20px}
    .live-dot{width:10px; height:10px; border-radius:999px; background:var(--warn); margin-left:8px; box-shadow:0 0 0 0 rgba(245,158,11,.5); animation:pulse 2s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(245,158,11,.5)}70%{box-shadow:0 0 0 10px rgba(245,158,11,0)}100%{box-shadow:0 0 0 0 rgba(245,158,11,0)}}
    .controls{display:flex; gap:8px}
    button{all:unset; background:var(--chip); border:1px solid var(--border); padding:10px 14px; border-radius:10px; cursor:pointer}
    button.brand{background:linear-gradient(90deg,var(--brand),var(--brand-2)); border:none; color:white}
    button:disabled{opacity:.65; cursor:not-allowed}
    .grid{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:0}
    .row{display:grid; grid-template-columns:220px 1fr; padding:14px 18px; border-bottom:1px solid var(--border)}
    .row:nth-child(odd){background:#15182a}
    .key{color:var(--muted)}
    .value{font-weight:600}
    .muted{color:var(--muted)}
    .chips{display:flex; flex-wrap:wrap; gap:8px; padding:14px 18px}
    .chip{background:var(--chip); border:1px solid var(--border); padding:8px 12px; border-radius:999px; font-size:13px}
    .chip.active{background:var(--chip-active); border-color:#3a3f66}
    .footer-note{margin-top:14px; color:var(--muted); font-size:13px; padding:0 18px 16px}
    .kpis{display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:12px; padding:14px 18px 18px}
    .kpi{background:var(--chip); border:1px solid var(--border); border-radius:12px; padding:12px}
    .kpi .label{color:var(--muted); font-size:12px}
    .kpi .val{font-size:20px; font-weight:800; margin-top:6px}
    .banner{margin:16px 0 0; padding:12px 16px; border:1px dashed #3a3f66; border-radius:12px; color:var(--muted)}
    .ok{color:var(--ok)} .warn{color:var(--warn)}
    @media (max-width:760px){
      .grid{grid-template-columns:1fr}
      .row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="title">SkyBank — Autoscaling Demo (Cloud Run)</div>
    <div class="sub">A tiny demo that shows which Cloud Run <em>container instance</em> served your request.</div>
  </header>

  <main>
    <section class="card" id="live">
      <div class="card-hd">
        <div class="card-ttl">Live instance info <span class="live-dot" id="liveDot" aria-hidden="true"></span></div>
        <div class="controls">
          <button class="brand" id="startBtn">Start Live Poll</button>
          <button id="stopBtn" disabled>Stop</button>
          <button id="copyBtn" title="Copy API URL">Copy API URL</button>
        </div>
      </div>

      <div class="grid" id="kv">
        <div class="row"><div class="key">Service</div><div class="value" id="svc">—</div></div>
        <div class="row"><div class="key">Revision</div><div class="value" id="rev">—</div></div>
        <div class="row"><div class="key">Instance Hostname</div><div class="value" id="host">—</div></div>
        <div class="row"><div class="key">PID</div><div class="value" id="pid">—</div></div>
        <div class="row"><div class="key">Requests on this instance</div><div class="value" id="rc">—</div></div>
        <div class="row"><div class="key">Time</div><div class="value" id="time">—</div></div>
      </div>

      <div class="kpis">
        <div class="kpi"><div class="label">Polls</div><div class="val" id="polls">0</div></div>
        <div class="kpi"><div class="label">Unique instances hit</div><div class="val" id="unique">0</div></div>
        <div class="kpi"><div class="label">Last change</div><div class="val" id="lastChange">—</div></div>
      </div>

      <div class="chips" id="instances" aria-live="polite"></div>
      <div class="footer-note muted">Tip: open this page in multiple tabs or run a load test to see instance chips multiply as Cloud Run scales.</div>
    </section>

    <div class="banner muted" id="hint">Want quicker scaling? Call <code>/stress?ms=800</code> from a load tool to increase per-request work.</div>
  </main>

  <script>
    const svcEl   = document.getElementById("svc");
    const revEl   = document.getElementById("rev");
    const hostEl  = document.getElementById("host");
    const pidEl   = document.getElementById("pid");
    const rcEl    = document.getElementById("rc");
    const timeEl  = document.getElementById("time");
    const pollsEl = document.getElementById("polls");
    const uniqueEl= document.getElementById("unique");
    const lastEl  = document.getElementById("lastChange");
    const listEl  = document.getElementById("instances");
    const startBtn= document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const copyBtn = document.getElementById("copyBtn");
    const liveDot = document.getElementById("liveDot");
    const HZ = 2000;

    let timer = null;
    let polls = 0;
    const seen = new Map(); // hostname -> hits

    function setLive(on){
      startBtn.disabled = on;
      stopBtn.disabled  = !on;
      liveDot.style.background = on ? "var(--ok)" : "var(--warn)";
    }

    async function tick(){
      try{
        const res = await fetch("/api", { cache:"no-store" });
        const data = await res.json();

        svcEl.textContent  = data.service || "—";
        revEl.textContent  = data.revision || "—";
        hostEl.textContent = data.instanceHostname || "—";
        pidEl.textContent  = data.pid ?? "—";
        rcEl.textContent   = data.requestCountOnThisInstance ?? "—";
        timeEl.textContent = data.time || "—";

        polls++; pollsEl.textContent = polls;

        // track unique instances & render chips
        const h = data.instanceHostname || "unknown";
        const prevSize = seen.size;
        seen.set(h, (seen.get(h) || 0) + 1);
        if (seen.size !== prevSize) {
          lastEl.textContent = new Date().toLocaleTimeString();
          renderChips();
        }
        uniqueEl.textContent = seen.size;

      }catch(e){
        console.error(e);
      }
    }

    function renderChips(){
      listEl.innerHTML = "";
      for (const [h, hits] of seen.entries()){
        const div = document.createElement("div");
        div.className = "chip active";
        div.title = `${hits} polls hit this instance`;
        div.textContent = h;
        listEl.appendChild(div);
      }
    }

    startBtn.addEventListener("click", () => {
      if (timer) return;
      setLive(true);
      tick(); // immediate
      timer = setInterval(tick, HZ);
    });

    stopBtn.addEventListener("click", () => {
      if (timer) clearInterval(timer);
      timer = null;
      setLive(false);
    });

    copyBtn.addEventListener("click", async () => {
      try{
        const url = new URL(location.href);
        url.pathname = "/api";
        await navigator.clipboard.writeText(url.toString());
        copyBtn.textContent = "Copied!";
        setTimeout(()=> copyBtn.textContent = "Copy API URL", 1200);
      }catch{ /* ignore */ }
    });
  </script>
</body>
</html>
